<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kalkulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Space Mono", monospace;
        background-color: #f3f4f6;
        background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
        background-size: 20px 20px;
      }

      .hard-shadow {
        box-shadow: 5px 5px 0px 0px #000000;
        transition: all 0.1s ease;
      }

      .hard-shadow:active {
        transform: translate(3px, 3px);
        box-shadow: 2px 2px 0px 0px #000000;
      }

      .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: #000;
        border-left: 2px solid #000;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #a855f7;
        border: 2px solid #000;
      }

      .history-overlay {
        transition: transform 0.3s cubic-bezier(0, 1, 0.5, 1);
      }
      .history-hidden {
        transform: translateY(110%);
        visibility: hidden;
      }
      .history-visible {
        transform: translateY(0);
        visibility: visible;
      }
    </style>
  </head>
  <body class="min-h-screen flex items-center justify-center p-4 select-none">
    <div
      class="relative w-full max-w-sm bg-[#FFF4DA] border-4 border-black h-[700px] flex flex-col shadow-[10px_10px_0px_0px_rgba(0,0,0,1)]"
    >
      <div
        class="bg-black text-[#00FF41] p-6 border-b-4 border-black flex flex-col relative z-20 h-48 justify-between"
      >
        <div class="flex justify-between items-center">
          <button
            id="btn-open-history"
            class="text-[#00FF41] hover:text-white transition p-1 rounded border border-[#00FF41] hover:bg-[#00FF41] hover:text-black"
          >
            <i class="fa-solid fa-clock-rotate-left text-lg"></i>
          </button>
          <span
            id="memory-indicator"
            class="text-xs font-bold uppercase tracking-widest opacity-50"
            >NO MEMORY</span
          >
        </div>
        <div class="text-right overflow-hidden">
          <div
            id="expression-display"
            class="text-[#00FF41] opacity-70 text-sm font-medium mb-1 min-h-[1.2rem] break-words"
          ></div>
          <div
            id="current-input"
            class="text-5xl font-bold tracking-tighter overflow-hidden text-ellipsis whitespace-nowrap"
          >
            0
          </div>
        </div>
      </div>
      <div class="flex border-b-4 border-black bg-white">
        <button
          data-memory="MC"
          class="flex-1 py-2 text-xs font-bold border-r-2 border-black hover:bg-red-200 transition"
        >
          MC
        </button>
        <button
          data-memory="MR"
          class="flex-1 py-2 text-xs font-bold border-r-2 border-black hover:bg-blue-200 transition"
        >
          MR
        </button>
        <button
          data-memory="M+"
          class="flex-1 py-2 text-xs font-bold border-r-2 border-black hover:bg-green-200 transition"
        >
          M+
        </button>
        <button
          data-memory="M-"
          class="flex-1 py-2 text-xs font-bold hover:bg-yellow-200 transition"
        >
          M-
        </button>
      </div>
      <div
        class="flex-1 bg-[#FFF4DA] p-5 flex flex-col justify-end relative overflow-hidden"
      >
        <div class="grid grid-cols-4 gap-3 h-full">
          <button
            data-action="CE"
            class="hard-shadow bg-[#ff90e8] border-2 border-black text-black font-bold text-lg rounded-none"
          >
            CE
          </button>
          <button
            data-action="C"
            class="hard-shadow bg-[#ff90e8] border-2 border-black text-black font-bold text-lg rounded-none"
          >
            C
          </button>
          <button
            data-action="DELETE"
            class="hard-shadow bg-[#ff90e8] border-2 border-black text-black font-bold text-lg rounded-none"
          >
            <i class="fa-solid fa-arrow-left"></i>
          </button>
          <button
            data-operation="÷"
            class="hard-shadow bg-[#ffc900] border-2 border-black text-black font-bold text-2xl rounded-none"
          >
            ÷
          </button>

          <button
            data-number="7"
            class="hard-shadow bg-white border-2 border-black text-black text-2xl font-bold rounded-none"
          >
            7
          </button>
          <button
            data-number="8"
            class="hard-shadow bg-white border-2 border-black text-black text-2xl font-bold rounded-none"
          >
            8
          </button>
          <button
            data-number="9"
            class="hard-shadow bg-white border-2 border-black text-black text-2xl font-bold rounded-none"
          >
            9
          </button>
          <button
            data-operation="×"
            class="hard-shadow bg-[#ffc900] border-2 border-black text-black font-bold text-2xl rounded-none"
          >
            ×
          </button>

          <button
            data-number="4"
            class="hard-shadow bg-white border-2 border-black text-black text-2xl font-bold rounded-none"
          >
            4
          </button>
          <button
            data-number="5"
            class="hard-shadow bg-white border-2 border-black text-black text-2xl font-bold rounded-none"
          >
            5
          </button>
          <button
            data-number="6"
            class="hard-shadow bg-white border-2 border-black text-black text-2xl font-bold rounded-none"
          >
            6
          </button>
          <button
            data-operation="-"
            class="hard-shadow bg-[#ffc900] border-2 border-black text-black font-bold text-2xl rounded-none"
          >
            −
          </button>

          <button
            data-number="1"
            class="hard-shadow bg-white border-2 border-black text-black text-2xl font-bold rounded-none"
          >
            1
          </button>
          <button
            data-number="2"
            class="hard-shadow bg-white border-2 border-black text-black text-2xl font-bold rounded-none"
          >
            2
          </button>
          <button
            data-number="3"
            class="hard-shadow bg-white border-2 border-black text-black text-2xl font-bold rounded-none"
          >
            3
          </button>
          <button
            data-operation="+"
            class="hard-shadow bg-[#ffc900] border-2 border-black text-black font-bold text-2xl rounded-none"
          >
            +
          </button>

          <button
            data-action="NEGATE"
            class="hard-shadow bg-white border-2 border-black text-black text-lg font-bold rounded-none"
          >
            +/-
          </button>
          <button
            data-number="0"
            class="hard-shadow bg-white border-2 border-black text-black text-2xl font-bold rounded-none"
          >
            0
          </button>
          <button
            data-number="."
            class="hard-shadow bg-white border-2 border-black text-black text-2xl font-bold rounded-none"
          >
            .
          </button>
          <button
            data-action="EQUALS"
            class="hard-shadow bg-black border-2 border-black text-white font-bold text-2xl rounded-none hover:bg-gray-800"
          >
            =
          </button>
        </div>
        <div
          id="history-view"
          class="history-overlay history-hidden absolute inset-0 bg-[#ff90e8] z-30 flex flex-col p-0 border-t-4 border-black"
        >
          <div
            class="flex justify-between items-center p-4 bg-black text-[#ff90e8] border-b-4 border-black"
          >
            <h3 class="font-bold text-xl tracking-tighter">RIWAYAT</h3>
            <button
              id="btn-close-history"
              class="text-[#ff90e8] hover:text-white border-2 border-[#ff90e8] px-2 py-1 rounded-none bg-black hover:bg-gray-800 transition font-bold"
            >
              X
            </button>
          </div>
          <div
            id="history-list"
            class="flex-1 overflow-y-auto p-4 custom-scrollbar space-y-3 bg-[#FFF4DA]"
          ></div>
          <div class="p-4 bg-[#FFF4DA] border-t-4 border-black">
            <button
              id="clear-history"
              class="hard-shadow w-full py-3 bg-red-500 text-white font-bold border-2 border-black text-sm hover:bg-red-600 uppercase tracking-widest"
            >
              Hapus Memori
            </button>
          </div>
        </div>
      </div>
    </div>
    <script>
      class Kalkulator {
        constructor(tampilanEkspresi, tampilanInputSaatIni) {
          this.tampilanEkspresi = tampilanEkspresi;
          this.tampilanInputSaatIni = tampilanInputSaatIni;
          this.elemenDaftarRiwayat = document.getElementById("history-list");
          this.indikatorMemori = document.getElementById("memory-indicator");
          this.inputSaatIni = "0";
          this.bagianEkspresi = [];
          this.memori = 0;
          this.riwayat = [];
          this.apakahHasilDitampilkan = false;
        }

        formatAngka(strAngka) {
          const angka = parseFloat(strAngka);
          if (isNaN(angka)) return "";
          return angka.toLocaleString("id-ID", { maximumFractionDigits: 10 });
        }

        perbaruiTampilan() {
          this.tampilanInputSaatIni.innerText = this.formatAngka(
            this.inputSaatIni
          );
          if (this.inputSaatIni.endsWith("."))
            this.tampilanInputSaatIni.innerText += ".";

          const visualEkspresi = this.bagianEkspresi
            .map((bagian) => {
              if (bagian === "/") return "÷";
              if (bagian === "*") return "×";
              if (bagian === "-") return "−";
              if (!isNaN(parseFloat(bagian)) && parseFloat(bagian) < 0)
                return `(${this.formatAngka(bagian)})`;
              return this.formatAngka(bagian) || bagian;
            })
            .join(" ");
          this.tampilanEkspresi.innerText = visualEkspresi;
        }

        tambahAngka(angka) {
          if (this.apakahHasilDitampilkan) {
            this.inputSaatIni = "";
            this.bagianEkspresi = [];
            this.apakahHasilDitampilkan = false;
          }
          if (angka === "." && this.inputSaatIni.includes(".")) return;
          if (this.inputSaatIni === "0" && angka !== ".")
            this.inputSaatIni = angka.toString();
          else if (this.inputSaatIni === "-0" && angka !== ".")
            this.inputSaatIni = "-" + angka.toString();
          else
            this.inputSaatIni = this.inputSaatIni.toString() + angka.toString();
        }

        negasi() {
          if (this.apakahHasilDitampilkan) {
            this.inputSaatIni = (parseFloat(this.inputSaatIni) * -1).toString();
            this.apakahHasilDitampilkan = false;
            this.bagianEkspresi = [];
          } else {
            if (this.inputSaatIni === "0") return;
            if (this.inputSaatIni.startsWith("-"))
              this.inputSaatIni = this.inputSaatIni.slice(1);
            else this.inputSaatIni = "-" + this.inputSaatIni;
          }
        }

        pilihOperasi(operasi) {
          if (this.apakahHasilDitampilkan) {
            this.apakahHasilDitampilkan = false;
            this.bagianEkspresi = [];
          }
          this.bagianEkspresi.push(this.inputSaatIni);
          let simbolOp = operasi;
          if (operasi === "×") simbolOp = "*";
          if (operasi === "÷") simbolOp = "/";
          if (operasi === "−") simbolOp = "-";
          this.bagianEkspresi.push(simbolOp);
          this.inputSaatIni = "0";
          this.perbaruiTampilan();
        }

        hitung() {
          this.bagianEkspresi.push(this.inputSaatIni);
          const visualEkspresiLengkap = this.bagianEkspresi
            .map((p) => {
              if (p === "*") return "×";
              if (p === "/") return "÷";
              if (!isNaN(parseFloat(p)) && parseFloat(p) < 0) return `(${p})`;
              return p;
            })
            .join(" ");
          const stringMatematika = this.bagianEkspresi.join(" ");

          try {
            const hasil = new Function("return " + stringMatematika)();
            if (!isFinite(hasil) || isNaN(hasil)) {
              alert("Error");
              this.hapusSemua();
              return;
            }
            this.tambahRiwayat(visualEkspresiLengkap, hasil);
            this.inputSaatIni = hasil.toString();
            this.bagianEkspresi = [];
            this.tampilanEkspresi.innerText = visualEkspresiLengkap + " =";
            this.apakahHasilDitampilkan = true;
          } catch (e) {
            this.hapusSemua();
          }
          this.tampilanInputSaatIni.innerText = this.formatAngka(
            this.inputSaatIni
          );
        }

        hapusSemua() {
          this.inputSaatIni = "0";
          this.bagianEkspresi = [];
          this.apakahHasilDitampilkan = false;
        }

        hapusEntri() {
          this.inputSaatIni = "0";
        }

        hapusKarakter() {
          if (this.apakahHasilDitampilkan) return;
          if (
            this.inputSaatIni.length === 1 ||
            (this.inputSaatIni.length === 2 &&
              this.inputSaatIni.startsWith("-"))
          )
            this.inputSaatIni = "0";
          else this.inputSaatIni = this.inputSaatIni.toString().slice(0, -1);
        }

        tambahRiwayat(ekspresi, hasil) {
          this.riwayat.unshift({ ekspresi, hasil });
          if (this.riwayat.length > 20) this.riwayat.pop();
          this.tampilkanRiwayat();
        }

        tampilkanRiwayat() {
          this.elemenDaftarRiwayat.innerHTML = "";
          if (this.riwayat.length === 0) {
            this.elemenDaftarRiwayat.innerHTML =
              '<div class="text-black text-center mt-10 font-bold opacity-50">LOG_KOSONG</div>';
            return;
          }
          this.riwayat.forEach((item) => {
            const div = document.createElement("div");
            div.className =
              "bg-white p-3 border-2 border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] cursor-pointer hover:translate-x-1 hover:translate-y-1 hover:shadow-none transition-all";
            div.innerHTML = `
                        <div class="text-xs text-gray-500 mb-1 text-right font-bold">${
                          item.ekspresi
                        } =</div>
                        <div class="text-xl font-bold text-black text-right">${this.formatAngka(
                          item.hasil
                        )}</div>
                    `;
            div.onclick = () => {
              this.inputSaatIni = item.hasil.toString();
              this.bagianEkspresi = [];
              this.apakahHasilDitampilkan = true;
              this.perbaruiTampilan();
              tutupPanelRiwayat();
            };
            this.elemenDaftarRiwayat.appendChild(div);
          });
        }

        bersihkanRiwayat() {
          this.riwayat = [];
          this.tampilkanRiwayat();
        }

        kelolaMemori(aksi) {
          const saatIni = parseFloat(this.inputSaatIni);
          if (isNaN(saatIni)) return;
          if (aksi === "MC") this.memori = 0;
          else if (aksi === "M+") this.memori += saatIni;
          else if (aksi === "M-") this.memori -= saatIni;
          else if (aksi === "MR") {
            this.inputSaatIni = this.memori.toString();
            this.apakahHasilDitampilkan = true;
          }

          if (this.memori !== 0) {
            this.indikatorMemori.innerText = `MEM: ${this.formatAngka(
              this.memori
            )}`;
            this.indikatorMemori.style.opacity = "1";
            this.indikatorMemori.classList.add("text-[#00FF41]");
          } else {
            this.indikatorMemori.innerText = "NO MEMORY";
            this.indikatorMemori.style.opacity = "0.5";
            this.indikatorMemori.classList.remove("text-[#00FF41]");
          }
          this.perbaruiTampilan();
        }
      }

      const kalkulator = new Kalkulator(
        document.getElementById("expression-display"),
        document.getElementById("current-input")
      );

      document.querySelectorAll("[data-number]").forEach((btn) =>
        btn.addEventListener("click", () => {
          kalkulator.tambahAngka(btn.innerText);
          kalkulator.perbaruiTampilan();
        })
      );
      document.querySelectorAll("[data-operation]").forEach((btn) =>
        btn.addEventListener("click", () => {
          kalkulator.pilihOperasi(btn.innerText);
          kalkulator.perbaruiTampilan();
        })
      );
      document.querySelectorAll("[data-memory]").forEach((btn) =>
        btn.addEventListener("click", () => {
          kalkulator.kelolaMemori(btn.dataset.memory);
        })
      );
      document
        .querySelector('[data-action="EQUALS"]')
        .addEventListener("click", () => kalkulator.hitung());
      document
        .querySelector('[data-action="C"]')
        .addEventListener("click", () => {
          kalkulator.hapusSemua();
          kalkulator.perbaruiTampilan();
        });
      document
        .querySelector('[data-action="CE"]')
        .addEventListener("click", () => {
          kalkulator.hapusEntri();
          kalkulator.perbaruiTampilan();
        });
      document
        .querySelector('[data-action="DELETE"]')
        .addEventListener("click", () => {
          kalkulator.hapusKarakter();
          kalkulator.perbaruiTampilan();
        });
      document
        .querySelector('[data-action="NEGATE"]')
        .addEventListener("click", () => {
          kalkulator.negasi();
          kalkulator.perbaruiTampilan();
        });

      const panelRiwayat = document.getElementById("history-view");

      function bukaPanelRiwayat() {
        panelRiwayat.classList.remove("history-hidden");
        panelRiwayat.classList.add("history-visible");
      }

      function tutupPanelRiwayat() {
        panelRiwayat.classList.remove("history-visible");
        panelRiwayat.classList.add("history-hidden");
      }

      document
        .getElementById("btn-open-history")
        .addEventListener("click", bukaPanelRiwayat);
      document
        .getElementById("btn-close-history")
        .addEventListener("click", tutupPanelRiwayat);
      document
        .getElementById("clear-history")
        .addEventListener("click", () => kalkulator.bersihkanRiwayat());

      document.addEventListener("keydown", (e) => {
        if ((e.key >= "0" && e.key <= "9") || e.key === ".") {
          kalkulator.tambahAngka(e.key);
          kalkulator.perbaruiTampilan();
        }
        if (e.key === "=" || e.key === "Enter") {
          e.preventDefault();
          kalkulator.hitung();
        }
        if (e.key === "Backspace") {
          kalkulator.hapusKarakter();
          kalkulator.perbaruiTampilan();
        }
        if (e.key === "Escape") {
          if (panelRiwayat.classList.contains("history-visible"))
            tutupPanelRiwayat();
          else {
            kalkulator.hapusSemua();
            kalkulator.perbaruiTampilan();
          }
        }
        if (["+", "-", "*", "/"].includes(e.key)) {
          const peta = { "*": "×", "/": "÷", "-": "-" };
          kalkulator.pilihOperasi(peta[e.key] || e.key);
        }
        if (e.key === "n" || e.key === "_") {
          kalkulator.negasi();
          kalkulator.perbaruiTampilan();
        }
      });
    </script>
  </body>
</html>
